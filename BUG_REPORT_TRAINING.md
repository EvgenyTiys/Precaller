# БАГ-РЕПОРТ: Раздел "Тренировка"
**Подготовил:** Senior QA Engineer  
**Дата:** 2024  
**Версия:** Текущая  
**Приоритет:** См. описание каждого бага

---

## КРИТИЧЕСКИЕ БАГИ (P0)

### BUG-001: Потеря данных при ошибке сохранения времени тренировки
**Приоритет:** P0 - Critical  
**Серьёзность:** High  
**Тип:** Data Loss / UX

**Описание:**
При ошибке сохранения времени тренировки в БД (например, потеря сети) секундомер уже остановлен, но данные не сохранены. Пользователь не может повторить попытку сохранения, так как кнопка "Завершить тренировку" скрыта и заменена на "В начало".

**Шаги воспроизведения:**
1. Начать тренировку
2. Пройти все слайды
3. Нажать "Завершить тренировку"
4. Имитировать ошибку сети (отключить интернет)
5. Наблюдать поведение

**Ожидаемое поведение:**
- Секундомер останавливается только после успешного сохранения
- При ошибке показывается возможность повторить попытку
- Время тренировки сохраняется в localStorage как резервная копия

**Фактическое поведение:**
- Секундомер останавливается до сохранения
- Кнопка "Завершить тренировку" исчезает
- Невозможно повторить попытку сохранения

**Файлы:**
- `public/js/training.js:827-871` (функция `finishTraining`)

**Рекомендации:**
1. Сохранять время в localStorage перед отправкой на сервер
2. Показывать кнопку "Повторить сохранение" при ошибке
3. Останавливать секундомер только после успешного сохранения

---

### BUG-002: XSS уязвимость в отображении ассоциаций
**Приоритет:** P0 - Critical  
**Серьёзность:** High  
**Тип:** Security

**Описание:**
В функции `displayFragmentAssociation()` и `displayStoryChain()` используется `innerHTML` с данными из БД без экранирования для emoji и customImage. Хотя для `customWord` используется `escapeHtml()`, для других полей экранирование отсутствует.

**Шаги воспроизведения:**
1. Создать текст с фрагментом
2. В мастере добавить кастомное изображение с URL: `<img src=x onerror=alert('XSS')>`
3. Открыть тренировку
4. Наблюдать выполнение JavaScript

**Ожидаемое поведение:**
- Все пользовательские данные экранируются перед вставкой в DOM
- JavaScript не выполняется

**Фактическое поведение:**
- Emoji и customImage вставляются без экранирования
- Возможна XSS атака через вредоносные данные

**Файлы:**
- `public/js/training.js:447-454` (функция `displayStoryChain`)
- `public/js/training.js:537-558` (функция `displayFragmentAssociation`)

**Рекомендации:**
1. Использовать `textContent` вместо `innerHTML` где возможно
2. Для изображений валидировать URL и использовать `createElement('img')` с установкой атрибутов
3. Для emoji использовать `textContent` или проверять на наличие только валидных emoji символов

---

## ВЫСОКИЕ БАГИ (P1)

### BUG-003: Потеря введённой фразы при переходе на последний слайд
**Приоритет:** P1 - High  
**Серьёзность:** Medium  
**Тип:** Data Loss

**Описание:**
При переходе на последний слайд через `goToNext()` введённая фраза для следующего фрагмента не сохраняется, так как проверка `currentFragmentIndex < trainingFragments.length - 1` не позволяет сохранить введённый текст.

**Шаги воспроизведения:**
1. Начать тренировку
2. На предпоследнем слайде ввести фразу следующего слайда
3. Нажать "Далее"
4. Наблюдать, что введённая фраза не отображается на последнем слайде

**Ожидаемое поведение:**
- Введённая фраза сохраняется и отображается на последнем слайде

**Фактическое поведение:**
- Введённая фраза теряется

**Файлы:**
- `public/js/training.js:657-681` (функция `goToNext`)

**Рекомендации:**
- Сохранять введённую фразу перед проверкой `currentFragmentIndex < trainingFragments.length - 1`

---

### BUG-004: Некорректная работа индикатора прогресса на слайде ввода
**Приоритет:** P1 - High  
**Серьёзность:** Medium  
**Тип:** UI/UX

**Описание:**
На слайде ввода (`currentFragmentIndex = -1`) функция `updateFragmentIndicator()` работает некорректно, так как проверка `index < currentFragmentIndex` будет true для всех индексов (все точки будут помечены как completed).

**Шаги воспроизведения:**
1. Начать тренировку
2. Наблюдать индикатор прогресса на слайде ввода
3. Все точки отображаются как completed

**Ожидаемое поведение:**
- На слайде ввода все точки должны быть неактивными или показывать специальное состояние

**Фактическое поведение:**
- Все точки помечены как completed из-за `-1 < index` для всех индексов

**Файлы:**
- `public/js/training.js:619-635` (функция `updateFragmentIndicator`)

**Рекомендации:**
- Добавить проверку `currentFragmentIndex >= 0` перед обработкой индикатора

---

### BUG-005: Отсутствие защиты от повторных запросов при завершении тренировки
**Приоритет:** P1 - High  
**Серьёзность:** Medium  
**Тип:** Data Integrity

**Описание:**
Пользователь может многократно нажать на кнопку "Завершить тренировку" или пробел, что приведёт к множественным запросам на сервер и созданию дублирующих записей в БД.

**Шаги воспроизведения:**
1. Пройти тренировку до конца
2. Быстро нажать "Завершить тренировку" несколько раз
3. Проверить БД на наличие дублирующих записей

**Ожидаемое поведение:**
- Кнопка блокируется после первого нажатия
- Повторные запросы игнорируются до завершения текущего

**Фактическое поведение:**
- Можно отправить несколько запросов
- Создаются дублирующие записи в БД

**Файлы:**
- `public/js/training.js:827-871` (функция `finishTraining`)

**Рекомендации:**
- Добавить флаг `isFinishing` для предотвращения повторных вызовов
- Блокировать кнопку во время выполнения запроса

---

## СРЕДНИЕ БАГИ (P2)

### BUG-006: Обработка пробела на слайде ввода может вызвать ошибку
**Приоритет:** P2 - Medium  
**Серьёзность:** Low  
**Тип:** Logic Error

**Описание:**
В функции `handleKeyboardShortcuts()` при `currentFragmentIndex = -1` (слайд ввода) проверка `currentFragmentIndex >= trainingFragments.length - 1` может работать некорректно, так как `-1 >= length - 1` будет false, но логика может быть неочевидной.

**Шаги воспроизведения:**
1. Начать тренировку (оказаться на слайде ввода)
2. Нажать пробел
3. Наблюдать поведение

**Ожидаемое поведение:**
- Пробел не должен вызывать завершение тренировки на слайде ввода

**Фактическое поведение:**
- Логика работает, но может быть неочевидной

**Файлы:**
- `public/js/training.js:148-194` (функция `handleKeyboardShortcuts`)

**Рекомендации:**
- Добавить явную проверку `currentFragmentIndex === -1` для слайда ввода

---

### BUG-007: Отсутствие валидации на пустой массив фрагментов
**Приоритет:** P2 - Medium  
**Серьёзность:** Low  
**Тип:** Edge Case

**Описание:**
Если текст не имеет фрагментов (массив пустой), приложение может работать некорректно. Нет проверки на `trainingFragments.length === 0`.

**Шаги воспроизведения:**
1. Создать текст без фрагментов (теоретически)
2. Попытаться начать тренировку
3. Наблюдать поведение

**Ожидаемое поведение:**
- Показывается сообщение об ошибке
- Тренировка не начинается

**Фактическое поведение:**
- Неизвестно (не протестировано)

**Файлы:**
- `public/js/training.js:260-286` (функция `loadTrainingText`)

**Рекомендации:**
- Добавить проверку `trainingFragments.length === 0` после загрузки

---

### BUG-008: Потеря прогресса при перезагрузке страницы
**Приоритет:** P2 - Medium  
**Серьёзность:** Low  
**Тип:** UX

**Описание:**
При перезагрузке страницы во время тренировки весь прогресс (введённые фразы, время) теряется. Нет сохранения состояния в localStorage.

**Шаги воспроизведения:**
1. Начать тренировку
2. Ввести несколько фраз
3. Перезагрузить страницу
4. Наблюдать потерю данных

**Ожидаемое поведение:**
- Прогресс сохраняется в localStorage
- При перезагрузке предлагается восстановить сессию

**Фактическое поведение:**
- Все данные теряются

**Файлы:**
- `public/js/training.js` (все функции)

**Рекомендации:**
- Реализовать автосохранение в localStorage
- Добавить функцию восстановления сессии

---

### BUG-009: Нет ограничения на максимальное время тренировки
**Приоритет:** P2 - Medium  
**Серьёзность:** Low  
**Тип:** Data Validation

**Описание:**
Секундомер может работать бесконечно, и при сохранении в БД может быть записано очень большое значение (например, если пользователь оставил страницу открытой на несколько дней).

**Шаги воспроизведения:**
1. Начать тренировку
2. Оставить страницу открытой на длительное время
3. Завершить тренировку
4. Проверить сохранённое время

**Ожидаемое поведение:**
- Есть разумное ограничение на максимальное время (например, 24 часа)
- При превышении показывается предупреждение

**Фактическое поведение:**
- Нет ограничений

**Файлы:**
- `public/js/training.js:781-791` (функция `startTimer`)
- `routes/training.js:119` (валидация на сервере)

**Рекомендации:**
- Добавить проверку максимального времени на клиенте и сервере

---

## НИЗКИЕ БАГИ (P3)

### BUG-010: Нет обработки случая, когда window.app не определён
**Приоритет:** P3 - Low  
**Серьёзность:** Low  
**Тип:** Error Handling

**Описание:**
В коде используется `window.app.showLoader()`, `window.app.apiRequest()` и т.д., но нет проверки на существование `window.app`. Если скрипт `app.js` не загрузился, возникнут ошибки.

**Шаги воспроизведения:**
1. Заблокировать загрузку `app.js`
2. Попытаться использовать тренировку
3. Наблюдать ошибки в консоли

**Ожидаемое поведение:**
- Graceful degradation или понятное сообщение об ошибке

**Фактическое поведение:**
- Ошибки JavaScript

**Файлы:**
- `public/js/training.js` (множественные места)

**Рекомендации:**
- Добавить проверки на существование `window.app` или использовать try-catch

---

### BUG-011: Нет обработки случая отсутствия элементов DOM
**Приоритет:** P3 - Low  
**Серьёзность:** Low  
**Тип:** Error Handling

**Описание:**
Хотя большинство функций проверяют существование элементов через `if (element)`, некоторые места могут вызвать ошибки, если элемент отсутствует.

**Рекомендации:**
- Добавить более строгие проверки или использовать optional chaining

---

### BUG-012: Потенциальная проблема с race condition при сохранении фраз
**Приоритет:** P3 - Low  
**Серьёзность:** Low  
**Тип:** Concurrency

**Описание:**
При быстром переключении между слайдами может возникнуть ситуация, когда введённая фраза не успевает сохраниться перед переходом.

**Рекомендации:**
- Сохранять введённые данные синхронно перед переходом

---

## УЛУЧШЕНИЯ (Enhancement)

### ENH-001: Добавить возможность паузы тренировки
**Приоритет:** Enhancement  
**Тип:** Feature Request

**Описание:**
Нет возможности поставить тренировку на паузу. Пользователь может только остановить секундомер, но не возобновить тренировку с того же места.

**Рекомендации:**
- Добавить кнопку "Пауза" / "Возобновить"
- Сохранять состояние при паузе

---

### ENH-002: Добавить статистику тренировок
**Приоритет:** Enhancement  
**Тип:** Feature Request

**Описание:**
Нет отображения истории тренировок и статистики (лучшее время, среднее время, количество тренировок).

**Рекомендации:**
- Добавить страницу статистики
- Использовать существующие методы БД `getTrainingSessionsByUserId`

---

### ENH-003: Улучшить обработку ошибок сети
**Приоритет:** Enhancement  
**Тип:** UX Improvement

**Описание:**
При потере сети показывается только общее сообщение об ошибке. Нет индикации, что это проблема сети, и нет автоматической повторной попытки.

**Рекомендации:**
- Определять тип ошибки (сеть vs сервер)
- Показывать соответствующие сообщения
- Реализовать retry механизм

---

## СТАТИСТИКА

- **Всего багов:** 12
- **Критических (P0):** 2
- **Высоких (P1):** 3
- **Средних (P2):** 4
- **Низких (P3):** 3
- **Улучшений:** 3

---

## ПРИОРИТЕТ ИСПРАВЛЕНИЙ

1. **BUG-001** - Потеря данных при ошибке (P0)
2. **BUG-002** - XSS уязвимость (P0)
3. **BUG-005** - Защита от дублирования запросов (P1)
4. **BUG-003** - Потеря введённой фразы (P1)
5. **BUG-004** - Индикатор прогресса (P1)
6. Остальные баги по приоритету

---

**Подготовил:** Senior QA Engineer  
**Дата:** 2024


